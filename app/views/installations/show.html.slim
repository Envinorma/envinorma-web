- content_for :meta_title, "Envinorma - #{@installation.name} - #{@installation.city}"

.container.mt-5
  - if @installation.duplicated_by_user?(cookies[:user_id])
    .alert.alert-secondary.small
      ' Cette installation a été créée par vos soins, vous la retrouverez dans l’onglet «
      = link_to 'Mes installations ', user_path, class: 'text-secondary'
      | ». Elle n’est pas accessible aux autres utilisateurs.

  h1.display-4
    => @installation.name
  - if @user.owned?(@installation)
    p
      = link_to "Modifier le nom de l'installation",
        edit_name_path(@installation)
  .row.mt-5
    .col
      h2.h5 Localisation
      p = "#{@installation.zipcode} #{@installation.city}"
      p = "#{@installation.department} - #{@installation.region}"

    .col
      h2.h5 Activités
      p = "N° inspection : #{@installation.s3ic_id}"
      p = "Dernière inspection : #{@installation.last_inspection&.strftime('%d/%m/%Y')}"
      p = "État d'activité : #{@installation.state}"

    .col
      h2.h5 Informations complémentaires
      p = "Régime en vigueur de l'établissement : #{@installation.regime}"
      p = "Statut SEVESO : #{@installation.seveso}"

  h2.mt-5 Classements

  p
    - if @user.owned?(@installation)
      = link_to 'Modifier les classements',
        edit_installation_path(@installation)
      = link_to 'Ajouter un nouveau classement', new_installation_classement_path(@installation), class: 'ml-3'
    - elsif @user.already_duplicated?(@installation)
      ' Vous souhaitez modifier ces classements ?
      = link_to 'Consulter votre version de l’installation.',
        installation_path(@user.retrieve_duplicated(@installation))
    - else
      ' Vous souhaitez modifier ces classements ?
      = link_to 'Créer une copie de l’installation (accessible par vous seul).',
        installations_path(id: @installation.id),
        method: :post

  table.table
    thead
      tr
        th Rubrique
        th Alinéa
        th Régime
        th Activité
        th Date d'autorisation
        th Date de mise en service
        th Volume

    tbody
      - @classements.each do |classement|
        tr
          td
            => classement.rubrique
            br
            small.text-secondary = classement.rubrique_acte
          td
            => classement.alinea
            br
            small.text-secondary = classement.alinea_acte

          td
            => t("regime.#{classement.regime}")
            br
            - if classement.regime_acte.present?
              small.text-secondary = t("regime.#{classement.regime_acte}")

          td = classement.activite
          td = classement.date_autorisation&.strftime('%d/%m/%Y')
          td = classement.date_mise_en_service&.strftime('%d/%m/%Y')
          td = classement.human_readable_volume

  .small.text-secondary
    | Sur chaque ligne
    br
    | - Classements en vigueur estimés à partir des évolutions de la nomenclature
    br
    | - Classements publiés dans un acte administratif

  .row
    .col
      h2.mt-5 Arrêtés ministériels associés
      - if @arretes.empty?
        p.text-secondary Il n’y a pas d’arrêté ministériel disponible pour cette installation.

      - else
        - @arretes.each do |arrete|
          .form-group.row
            .col
              .form-check.checkbox-custom
                = check_box_tag "arrete_#{arrete.id}",
                  '1', arrete.version_descriptor.applicable,
                  class: 'form-check-input js_arrete_checkbox js_checkbox',
                  'data-arrete-id': arrete.id
                = label_tag "arrete_#{arrete.id}",
                  class: arrete.version_descriptor.applicable ? 'active' : 'inactive'

                  span.tooltip-underline data-tooltip=arrete.title
                    = arrete.short_title
                  small.text-secondary
                    = " - #{classement_infos(arrete, @installation)}"

            - if arrete.version_descriptor.applicability_warnings.present?
              - warnings = arrete.version_descriptor.applicability_warnings.join(' - ')
              li.tooltip-warning data-tooltip=warnings
                i.fas.fa-exclamation-triangle

    .col
      h2.mt-5 Arrêtés préfectoraux associés
      - if @aps.empty?
        p.text-secondary Il n’y a pas d’arrêté préfectoral disponible pour cette installation.
      - else
        - @aps.each do |ap|
          .form-group.row
            .col
              .form-check.checkbox-custom
                = check_box_tag "ap_#{ap.id}",
                  '1', true,
                  class: 'form-check-input js_ap_checkbox js_checkbox',
                  'data-ap-id': ap.id
                = label_tag "ap_#{ap.id}"
                  = ap.short_title

                  small.text-secondary
                    = " - #{ap.description}"

  hr.mb-5.mt-5
  - if @arretes.any? || @aps.any?
      = link_to "Voir les prescriptions pour générer une fiche d'inspection",
        arretes_path(@installation, arrete_ids: @arretes.pluck(:id), ap_ids: @aps.pluck(:id)),
        data: { disable_with: "Voir les prescriptions pour générer une fiche d'inspection" },
        class: 'btn btn-primary mb-4 btn-fixed-bottom',
        id: 'arretes_link_button'
